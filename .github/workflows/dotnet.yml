name: .NET

on:
  push:
    branches: 
      - "master"
      - "feature/**"
  pull_request:
    branches: [ "master" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: 6.0.x
    - name: Restore dependencies
      run: dotnet restore
    
    - name: generate appsettings.json
      env:
        APP_TOKEN: ${{ secrets.APP_TOKEN }}
        #ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        
      run: |
        ### Create appsettings.json
        echo '\                                                                                                                                                                           130 тип
        { \
          "discordAppToken": "${APP_TOKEN}", \
          // the emoji the bot will use when a message is sent \
          "sent_emoji": ":ballot_box_with_check:", \
          // a 256 bit key used to generate response codes and usernames \
          "encryptionKey": "${ENCRYPTION_KEY}", \
          "ConnectionStrings": { \
                "sql": "Server=(localdb)\\mssqllocaldb;Database=Voltaire;Trusted_Connection=True;" \
          } \
        }' > ./Voltaire/appsettings.json
        
        ### Generate AES256 key
        export ENCRYPTION_KEY=$(openssl rand 32 | base64)
        
        ### Substiture for variables
        envsubst < ./Voltaire/appsettings.json > ./Voltaire/appsettings.json.tmp
        mv ./Voltaire/appsettings.json.tmp ./Voltaire/appsettings.json
        
        cat ./Voltaire/appsettings.json
      
    - name: Build
      run: dotnet build --no-restore
    - name: Test
      run: dotnet test --no-build --verbosity normal
    - name: Publish
      run: dotnet publish -c Release -o voltaire.dll
      
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: voltaire.dll
        path: voltaire.dll
